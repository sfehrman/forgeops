# ForgeRock stack secrets generator

## Disclaimer

>These samples are provided on an “as is” basis, without warranty of any kind, to the fullest extent
permitted by law. ForgeRock does not warrant or guarantee the individual success developers
may have in implementing the code on their development platforms or in
production configurations. ForgeRock does not warrant, guarantee or make any representations
regarding the use, results of use, accuracy, timeliness or completeness of any data or
information relating to these samples. ForgeRock disclaims all warranties, expressed or implied, and
in particular, disclaims all warranties of merchantability, and warranties related to the code, or any
service or software related thereto. ForgeRock shall not be liable for any direct, indirect or
consequential damages or costs of any type arising out of any action taken by you or others related
to the samples.

### Overview

- Attempts to randomly generate all secrets for ForgeRock AM, IDM and DS.
- Runs as a Kubernetes job when products are deployed
- The job attempts to be idempotent, only generating secrets if they do not already exist
- Currently works for 6.5 and 7.x
- For 6.5, a CA is created using keytool and https/ldaps certs are signed by this CA for AM/IDM/DS.
- For 7.0, the new DS `dskeymgr` tool is used to build a CA and also issue/sign certs for AM/IDM/DS.
- A java trust store is built and mounted on amster, DS, AM, IDM, allowing the services to trust each other's certs.

### Major additions/changes to CDK/CDM artifacts

- The amster pod has been modified to allow it to execute arbitrary scripts before amster scripts. An additional script is added here which configures the DS profile accounts with random passwords before amster executes.
- The DS init container has been modified to have a ds-init.sh script which configures the `uid=admin` password before DS starts.

## Usage WARNING
Please take note of the legal disclimer at the top of this document.

These tools make an effort to randomly generate all secrets for a **default** AM, DS and IDM deployment at the time of writing.
- These tools may become out of date
- There may be additional secrets in your deployment that are not generated by these tools.
- Usage of this tooling does not mean security best practice should not be applied. Secrets should still be rotated, audits should be carried out, security should be tested.
- If you choose to use this tooling to generate your secrets, make sure to back up your secrets. One method of doing this is described further down this document.
- Make sure to read the whole of this document and associated security sections of product documentation on https://backstage.forgerock.com. 

## Detailed information


### Usage
1. Configure as usual (`bin/config.sh init -v 6.5` or  `bin/config.sh init -v 7.0`)
1. Deploy CDK/CDM as usual ( `skaffold dev` or `skaffold dev -f skaffold-6.5.yaml`)
1. Wait for the forgeops-secrets job to complete.
1. View common passwords `bin/print-secrets.sh 7.0` or `bin/print-secrets.sh 6.5`)
1. Backup the generated secrets `kubectl get secret -lsecrettype=forgeops-generated -o yaml > secrets.yaml`

### setting all passwords to the same value (for dev, automated testing)
To have all passwords set with the same value, create a single file called `OVERRIDE_ALL_PASSWORDS.txt` to `forgeops-secrets-image/config` folder.

### Security considerations, things that could be improved

- the AM runtime container requires the Directory Manager password as an environment variable to check whether AM has been configured. This is not ideal as it presently requires full root access to DS to complete the check from within the web facing container. 
- the directory manager password is currently the same for all DS types
- no DS replication admin password is configured in 6.5
- the SMS transport key is not generated, a static value is used to ensure compatability with previous amster configs.
- metrics/monitoring secrets are still at their defaults

### 6.5 Secrets
- am-boot-secrets 
    - .keypass
    - .storepass
    - authorized_keys
    - keystore.jceks
- am-env-secrets 
    - CFGDIR_PASS
- am-https 
    - keypass
    - keystore.jceks
    - storepass
- am-runtime-keystore
    - keystore-runtime.jceks
- am-runtime-passwords
    - keypassruntime
    - storepassruntime
- amster 
    - authorized_keys
    - id_rsa
    - id_rsa.pub
- amster-env-secrets 
    - AMADMIN_PASS
    - AM_ENC_KEY
    - AM_POLICY_AGENT_PASS
    - CFGDIR_PASS
    - CFGUSR_PASS
    - CTSDIR_PASS
    - CTSUSR_PASS
    - USRUSR_PASS
- ds
    - dirmanager.pw
    - keystore.pin
    - monitor.pw
    - ssl-keystore.p12
- idm
    - keystore.jceks
    - truststore
- idm-env-secrets
    - OPENIDM_ADMIN_PASSWORD
    - OPENIDM_KEYSTORE_PASSWORD
    - OPENIDM_REPO_PASSWORD
    - USERSTORE_PASSWORD
- platform-ca
    - ca.jceks
    - ca.pem
    - keypass
    - storepass
- postgres-secrets
    - postgres-password
- truststore
    - cacerts

### 7.0 Secrets
- am-boot-secrets
    - .keypass
    - .storepass
    - authorized_keys
    - keystore.jceks
- am-env-secrets
    - CFGDIR_PASS
- am-https
    - keystore.p12
    - keystore.pin
- am-runtime-keystore
    - keystore-runtime.jceks
- am-runtime-passwords 
    - keypassruntime
    - storepassruntime
- amster 
    - authorized_keys
    - id_rsa
    - id_rsa.pub
- amster-env-secrets 
    - AMADMIN_PASS
    - AM_ENC_KEY
    - AM_POLICY_AGENT_PASS
    - CFGDIR_PASS
    - CFGUSR_PASS
    - CTSDIR_PASS
    - CTSUSR_PASS
    - IDM_PROVISIONING_CLIENT_SECRET
    - IDM_RS_CLIENT_SECRET
    - USRDIR_PASS
    - USRUSR_PASS
- ds 
    - keystore
    - keystore.pin
- ds-deployment-key
    - deploymentkey.key
    - deploymentkey.pin
- ds-passwords
    - dirmanager.pw
    - monitor.pw
- idm 
    - keystore.jceks
    - truststore
- idm-env-secrets
    - OPENIDM_ADMIN_PASSWORD
    - OPENIDM_KEYSTORE_PASSWORD
    - OPENIDM_REPO_PASSWORD
    - RS_CLIENT_SECRET
    - USERSTORE_PASSWORD
- platform-ca
    - ca.pem
- truststore
    - cacerts


